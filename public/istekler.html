<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İstekler - Just MSKU</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background-color: #000; color: #fff; display: flex; flex-direction: column; min-height: 100vh; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #1a1a1a; border-bottom: 1px solid #333; height: 70px; position: sticky; top: 0; z-index: 100;}
        header h1 { color: #24caac; font-size: 20px; cursor: pointer; }
        
        .back-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; text-decoration: none; font-size: 12px; }
        
        .container { max-width: 600px; margin: 20px auto; width: 100%; padding: 0 15px; }
        
        .request-card { background: #1a1a1a; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #333; margin-bottom: 15px; transition: 0.3s; }
        
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #24caac; }
        
        .btn-group { display: flex; gap: 5px; }
        .btn { padding: 8px 15px; border-radius: 20px; border: none; font-weight: 600; cursor: pointer; font-size: 12px; }
        .btn-accept { background: #24caac; color: #000; }
        .btn-reject { background: #333; color: #ccc; }
        .btn:hover { opacity: 0.8; }

        h2 { font-size: 18px; }
        .empty-state { text-align: center; color: #555; margin-top: 50px; display: none; }
    </style>
</head>
<body>
    <header>
        <h1 onclick="window.location.href='pylsmgemini.html'">Just MSKU</h1>
        <a href="pylsmgemini.html" class="back-btn">Geri Dön</a>
    </header>

    <div class="container">
        <h2 style="color: #24caac; margin-bottom: 20px;">Takip İstekleri <span id="reqCount" style="font-size:14px; color:#888;">(0)</span></h2>
        
        <div id="requestsContainer">
            <p style="color: #666; font-size: 14px; text-align:center; margin-top:20px;">Yükleniyor...</p>
        </div>
        
        <div id="emptyState" class="empty-state">
            <p>Bekleyen yeni bir istek yok.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLRlyPJvO5tPtnuzNAtO6H0_t7mo_3qoU",
            authDomain: "justmsku.firebaseapp.com",
            projectId: "justmsku",
            storageBucket: "justmsku.firebasestorage.app",
            messagingSenderId: "424626283802",
            appId: "1:424626283802:web:83502f1c09cdcf9acd78a3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const defaultAvatar = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadRequests(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // İSTEKLERİ ÇEKME FONKSİYONU
        async function loadRequests(myUid) {
            const container = document.getElementById('requestsContainer');
            const emptyState = document.getElementById('emptyState');
            
            // DİKKAT: 'relationships' koleksiyonunda BANA (followingUid) gelen ve DURUMU 'pending' olanları çekiyoruz.
            const q = query(
                collection(db, "relationships"), 
                where("followingUid", "==", myUid),
                where("status", "==", "pending")
            );
            
            try {
                const querySnapshot = await getDocs(q);

                container.innerHTML = ""; 

                if (querySnapshot.empty) {
                    emptyState.style.display = 'block';
                    document.getElementById('reqCount').innerText = "(0)";
                } else {
                    emptyState.style.display = 'none';
                    document.getElementById('reqCount').innerText = `(${querySnapshot.size})`;
                    
                    // Her bir istek için döngüye gir
                    // map ile tüm istekleri paralel olarak işleyelim (Daha hızlı yüklenir)
                    const promises = querySnapshot.docs.map(async (docSnap) => {
                        const relData = docSnap.data();
                        const relId = docSnap.id;
                        const requesterUid = relData.followerUid; // İsteği gönderen kişi

                        // İsteği gönderen kişinin Profil Bilgilerini 'users' tablosundan çek
                        const userDoc = await getDoc(doc(db, "users", requesterUid));
                        
                        let userName = "Bilinmeyen Kullanıcı";
                        let userImg = defaultAvatar;
                        let userBio = "MSKU Öğrencisi";

                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            userName = userData.username || userName;
                            userImg = userData.photoURL || userImg;
                            userBio = userData.bio || userBio;
                        }

                        // Kartı oluştur
                        return `
                            <div class="request-card" id="card-${relId}">
                                <div class="user-info" onclick="window.location.href='takip.html?kisi=${requesterUid}'">
                                    <img src="${userImg}" alt="User">
                                    <div>
                                        <h4 style="margin:0; font-size: 14px;">${userName}</h4>
                                        <span style="font-size:11px; color:#888;">${userBio.substring(0, 30)}...</span>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-accept" onclick="processRequest('${relId}', true)">Onayla</button>
                                    <button class="btn btn-reject" onclick="processRequest('${relId}', false)">Sil</button>
                                </div>
                            </div>
                        `;
                    });

                    // Tüm veriler çekilip HTML oluşturulana kadar bekle
                    const htmlArray = await Promise.all(promises);
                    container.innerHTML = htmlArray.join('');
                }
            } catch (error) {
                console.error("İstekler çekilirken hata:", error);
                container.innerHTML = "<p style='color:red; text-align:center;'>Bir hata oluştu.</p>";
            }
        }

        // KABUL ET / REDDET FONKSİYONU
        window.processRequest = async function(docId, isAccepted) {
            const card = document.getElementById(`card-${docId}`);
            if(card) card.style.opacity = "0.5"; // İşlem yapıldığını belli et

            try {
                const relRef = doc(db, "relationships", docId);

                if (isAccepted) {
                    // Onayla: Durumu 'pending' -> 'accepted' yap
                    await updateDoc(relRef, {
                        status: 'accepted'
                    });
                    console.log("İstek onaylandı.");
                } else {
                    // Reddet: Dokümanı sil
                    await deleteDoc(relRef);
                    console.log("İstek silindi.");
                }

                // Kartı kaldır
                if(card) {
                    card.remove();
                    
                    // Sayacı güncelle
                    const countSpan = document.getElementById('reqCount');
                    let currentCount = parseInt(countSpan.innerText.replace(/\D/g,''));
                    if(currentCount > 0) {
                        currentCount--;
                        countSpan.innerText = `(${currentCount})`;
                    }
                    
                    // Hepsi bittiyse boş durumu göster
                    if(document.querySelectorAll('.request-card').length === 0) {
                        document.getElementById('emptyState').style.display = 'block';
                    }
                }

            } catch (error) {
                console.error("İşlem hatası:", error);
                alert("Hata oluştu.");
                if(card) card.style.opacity = "1";
            }
        }
    </script>
</body>
</html>